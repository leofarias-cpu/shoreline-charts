import fse from 'fs-extra'
import path from 'path'
import { codeToHtml } from 'shiki'
import { format } from 'prettier'

const inputDir = `${path.dirname('')}/examples`
const outputFileName = 'index.ts'
const outputFile = `${path.dirname('')}/__examples__/${outputFileName}`

let tsCode = `
// This file is autogenerated by scripts/build-examples.mjs
// Do not edit this file directly.
import * as React from "react"

export default {
`

async function main() {
  const files = fse.readdirSync(inputDir)

  fse.removeSync(`${path.dirname('')}/__examples__`)

  const promises = files.map((file) => {
    const fileBuffer = fse.readFileSync(`${inputDir}/${file}`)
    const code = fileBuffer.toString()

    return codeToHtml(code, {
      lang: 'javascript',
      theme: 'github-light',
    })
  })

  const codes = await Promise.all(promises)

  for (const i in files) {
    const file = files[i]
    const fileName = file.split('.')[0]

    tsCode += `
      "${fileName}": {
        component: React.lazy(() => import('../examples/${fileName}')),
        code: \`${codes[i]}\`,
      },
      `
  }

  tsCode += '}'

  const formattedTsCode = await format(tsCode, {
    parser: 'typescript',
    semi: false,
    singleQuote: true,
  })

  fse.outputFile(outputFile, formattedTsCode, (err) => {
    if (err) {
      console.log(err)
    } else {
      console.log('Examples generated')
    }
  })
}

main()
