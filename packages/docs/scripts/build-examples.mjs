import fse from 'fs-extra'
import path from 'path'
import { codeToHtml } from 'shiki'
import { format } from 'prettier'

const dir = `${path.dirname('')}/examples`

let tsCode = `
// This file is autogenerated by scripts/build-examples.mjs
// Do not edit this file directly.
import * as React from "react"

export default {
`

async function main() {
  const files = fse.readdirSync(`${path.dirname('')}/examples`)

  await Promise.all(
    files.map(async (file) => {
      const fileBuffer = fse.readFileSync(`${dir}/${file}`)
      const fileName = file.split('.')[0]
      const code = fileBuffer.toString()

      const html = await codeToHtml(code, {
        lang: 'javascript',
        theme: 'github-light',
      })

      tsCode += `
      "${fileName}": {
        component: React.lazy(() => import('./${fileName}')),
        code: \`${html}\`,
      },
      `
    })
  )

  tsCode += '}'

  const formattedTsCode = await format(tsCode, {
    parser: 'typescript',
    semi: false,
    singleQuote: true,
  })

  fse.outputFile(
    `${path.dirname('')}/examples/index.ts`,
    formattedTsCode,
    (err) => {
      if (err) {
        console.log(err)
      } else {
        console.log('Examples generated')
      }
    }
  )
}

main()
