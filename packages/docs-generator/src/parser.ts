/* eslint-disable no-await-in-loop */
import { readFileSync } from 'fs'
import {
  generateComponent,
  generateComponentMetaJSON,
  generateRootMetaJSON,
} from './handlers'
import { isComponent } from './strings'
import { ProjectParser } from 'typedoc-json-parser'
import type { PkgToBeDocumentedPaths } from './config'
import { tmpDocsJsonPath } from './config'

/**
 * Parse the JSON docs generated by typedoc and generate the docs for the
 * components using the json-parser and handlebars.
 */
export async function parseJSONDocs(paths: PkgToBeDocumentedPaths) {
  const data = JSON.parse(readFileSync(tmpDocsJsonPath, 'utf8'))
  const project = new ProjectParser({ data })

  if (paths.components?.docPath && paths.components?.filename) {
    for (const func of project.functions) {
      if (isComponent(func.name)) {
        await Promise.all([
          generateComponent(project, func, paths.components),
          generateComponentMetaJSON(func, paths.components),
        ])
      }
    }

    await generateRootMetaJSON(project, paths)
  }
}
