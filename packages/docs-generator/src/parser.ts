/* eslint-disable no-await-in-loop */
import { readFileSync } from 'fs'
import { generateComponent, generateMetaJSON } from './handlers'
import { isComponent } from './strings'
import { ProjectParser } from 'typedoc-json-parser'
import type { PkgToBeDocumentedPaths } from './config'
import { tmpDocsJsonPath } from './config'

/**
 * Parse the JSON docs generated by typedoc and generate the docs for the
 * components using the json-parser and handlebars.
 */
export async function parseJSONDocs(paths: PkgToBeDocumentedPaths) {
  const data = JSON.parse(readFileSync(tmpDocsJsonPath, 'utf8'))
  const project = new ProjectParser({ data })

  for (const func of project.functions) {
    if (paths.components && isComponent(func.name)) {
      await generateComponent(project, func, paths.components)
    }

    await generateMetaJSON(project, paths)
  }
}
